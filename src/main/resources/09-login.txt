ä½ è¿™ä¸ªé—®é¢˜é—®å¾—éå¸¸å…³é”®ï¼Œè€Œä¸”ä½ è¯´å¾—å®Œå…¨å¯¹ ğŸ‘
ğŸ‘‰ è¿™æ˜¯æˆ‘ä¹‹å‰çš„â€œæŠ€æœ¯å€ºâ€ï¼Œç°åœ¨æˆ‘ä»¬ä¸€æ¬¡æ€§è¡¥é½ï¼Œå¹¶ä¸”æŒ‰ä½ è¦æ±‚ï¼šå®Œæ•´ã€å¯è¿è¡Œã€å°ç™½å¯å¤åˆ¶ã€‚

é—®é¢˜æœ¬è´¨è¯´æ˜ï¼ˆå…ˆè¯´ç»“è®ºï¼‰

ä½ ä¹‹å‰è¢«è¦æ±‚è°ƒç”¨ï¼š

POST /process/start


ä½†å®é™…ä¸Šï¼š

æˆ‘ä¹‹å‰ç¡®å®æ²¡æœ‰ç»™ä½ å†™è¿™ä¸ªæ¥å£

Camunda ä¸ä¼šè‡ªåŠ¨æš´éœ² /process/start

ä¸å†™ Controllerï¼Œè¿™ä¸ªæ¥å£æ ¹æœ¬ä¸å­˜åœ¨

ğŸ‘‰ è§£å†³åŠæ³•åªæœ‰ä¸€ä¸ªï¼šæˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ªã€Œæµç¨‹å¯åŠ¨æ¥å£ã€

Phase 9.5ï¼ˆè¡¥ç¼ºï¼‰ï¼šæµç¨‹å¯åŠ¨æ¥å£ /process/start

è¿™ä¸ªæ¥å£çš„èŒè´£æ˜¯ï¼š

æ ¡éªŒç™»å½•ç”¨æˆ·

æ ¡éªŒæ˜¯å¦æœ‰â€œå‘èµ·æµç¨‹â€æƒé™

å‘ Camunda å¯åŠ¨æµç¨‹

è®¾ç½®æµç¨‹å˜é‡ï¼ˆå‘èµ·äººã€åŠ¨æ€å®¡æ‰¹äººï¼‰

ä¸€ã€æ¥å£è®¾è®¡ï¼ˆä½ å‰ç«¯çœŸæ­£è¯¥è°ƒçš„ï¼‰
POST /process/start
Authorization: Bearer <JWT>

Body:
{
  "processKey": "leave_process",
  "variables": {
    "days": 3,
    "reason": "è¯·å‡"
  }
}

äºŒã€åç«¯å®Œæ•´ç›®å½•ç»“æ„ï¼ˆæ–°å¢éƒ¨åˆ†ï¼‰
workflow-engine
â”œâ”€â”€ src/main/java/com/example/workflow
â”‚   â”œâ”€â”€ workflow
â”‚   â”‚   â”œâ”€â”€ controller
â”‚   â”‚   â”‚   â””â”€â”€ ProcessController.java   âœ… æ–°å¢
â”‚   â”‚   â””â”€â”€ service
â”‚   â”‚       â””â”€â”€ ProcessService.java      âœ… æ–°å¢

ä¸‰ã€ProcessControllerï¼ˆå®Œæ•´ä»£ç ï¼‰

ğŸ“Œ è¿™æ˜¯ /process/start çš„çœŸæ­£å®ç°

package com.example.workflow.workflow.controller;

import com.example.workflow.common.response.R;
import com.example.workflow.workflow.service.ProcessService;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.Map;

@RestController
@RequestMapping("/process")
public class ProcessController {

    @Resource
    private ProcessService processService;

    /**
     * å¯åŠ¨æµç¨‹
     */
    @PostMapping("/start")
    public R<String> startProcess(
            @RequestParam("processKey") String processKey,
            @RequestBody Map<String, Object> variables,
            @RequestHeader("X-User-Id") Long userId,
            @RequestHeader("X-Username") String username
    ) {
        String processInstanceId =
                processService.start(processKey, variables, userId, username);
        return R.ok(processInstanceId);
    }
}


âš ï¸ è¯´æ˜

X-User-Idã€X-Username æ¥è‡ª JwtFilterï¼ˆä½ å·²ç»æœ‰ï¼‰

ä¸ä¿¡ä»»å‰ç«¯ä¼  userIdï¼Œåªä¿¡ JWT

å››ã€ProcessServiceï¼ˆçœŸæ­£è°ƒç”¨ Camundaï¼‰
package com.example.workflow.workflow.service;

import org.camunda.bpm.engine.RuntimeService;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.util.HashMap;
import java.util.Map;

@Service
public class ProcessService {

    @Resource
    private RuntimeService runtimeService;

    public String start(
            String processKey,
            Map<String, Object> variables,
            Long userId,
            String username
    ) {
        Map<String, Object> vars = new HashMap<>();

        if (variables != null) {
            vars.putAll(variables);
        }

        // ====== æ ¸å¿ƒæµç¨‹å˜é‡ ======
        vars.put("starterUserId", userId);
        vars.put("starterUsername", username);

        return runtimeService
                .startProcessInstanceByKey(processKey, vars)
                .getProcessInstanceId();
    }
}

äº”ã€BPMN ä¸­å¦‚ä½•ä½¿ç”¨è¿™äº›å˜é‡ï¼ˆéå¸¸é‡è¦ï¼‰
ç¤ºä¾‹ï¼šå‘èµ·äººå®¡æ‰¹ï¼ˆæœ€å¸¸è§ï¼‰
<bpmn:userTask id="starterApprove" name="å‘èµ·äººç¡®è®¤">
  <bpmn:extensionElements>
    <camunda:assignee>${starterUsername}</camunda:assignee>
  </bpmn:extensionElements>
</bpmn:userTask>

ç¤ºä¾‹ï¼šä¸Šçº§å®¡æ‰¹ï¼ˆä½  Phase 6 ç”¨åˆ°çš„ï¼‰
<camunda:assignee>${leaderUsername}</camunda:assignee>


leaderUsername å¯ä»¥åœ¨ æµç¨‹å¯åŠ¨å‰æŸ¥ DB åå¡è¿›å»

å…­ã€å‰ç«¯åº”è¯¥æ€ä¹ˆè°ƒï¼ˆVue / Axiosï¼‰
startProcess() {
  return request({
    url: '/process/start?processKey=leave_process',
    method: 'post',
    data: {
      days: 3,
      reason: 'è¯·å‡'
    }
  })
}


JWT â†’ request interceptor
userId / username â†’ JwtFilter è‡ªåŠ¨æ³¨å…¥ Header

ä¸ƒã€ä¸ºä»€ä¹ˆ Camunda å®˜æ–¹æ–‡æ¡£ä¼šâ€œè¯¯å¯¼ä½ â€

Camunda æ–‡æ¡£é‡Œç»å¸¸å†™ï¼š

â€œè°ƒç”¨ RuntimeService.startProcessInstanceByKeyâ€

ä½†é‚£æ˜¯ Java APIï¼Œä¸æ˜¯ HTTP æ¥å£

ğŸ‘‰ Camunda ä¸ä¼šè‡ªåŠ¨ç»™ä½  REST æ¥å£ï¼ˆé™¤éç”¨ camunda-restï¼‰
ğŸ‘‰ ä¼ä¸šé¡¹ç›® 100% éƒ½æ˜¯è‡ªå·±å†™ Controller

ä½ ç°åœ¨è¿™å¥—å†™æ³•ï¼š

âœ” å¯æ§

âœ” å¯é‰´æƒ

âœ” å¯å®¡è®¡

âœ” å¯æ‰©å±•

å…«ã€ä½ ç°åœ¨å¯ä»¥è‡ªæ£€è¿™ 4 ä»¶äº‹

1ï¸âƒ£ é¡¹ç›®ä¸­æ˜¯å¦å­˜åœ¨
ProcessController.java

2ï¸âƒ£ å‰ç«¯æ˜¯å¦è¯·æ±‚
/process/start

3ï¸âƒ£ BPMN ä¸­æ˜¯å¦ä½¿ç”¨
${starterUsername}

4ï¸âƒ£ æµç¨‹æ˜¯å¦æˆåŠŸç”Ÿæˆå®ä¾‹
ACT_RU_EXECUTION

ä¸‹ä¸€æ­¥å»ºè®®ï¼ˆéå¸¸è‡ªç„¶ï¼‰

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥ç»§ç»­å¸®ä½ è¡¥ï¼š

Phase 10ï¼šæµç¨‹å›é€€ / é©³å› / è½¬åŠï¼ˆä¼ä¸šæœ€ç—›ç‚¹ï¼‰

Phase 11ï¼šæµç¨‹å†å² & å®¡æ‰¹è½¨è¿¹å‰ç«¯å±•ç¤º

Phase 12ï¼šå¤šæµç¨‹ç»Ÿä¸€å¯åŠ¨é¡µé¢ï¼ˆåƒ OAï¼‰

ä½ åªéœ€è¦è¯´ä¸€å¥ğŸ‘‡
ğŸ‘‰ â€œç»§ç»­ Phase 10â€