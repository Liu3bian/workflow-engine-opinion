å¤ªå¥½äº†ã€‚
Phase 4 æ˜¯æ•´ä¸ªç³»ç»Ÿä»â€œèƒ½ç™»å½•â€åˆ°â€œçœŸæ­£èƒ½æ§æƒâ€çš„åˆ†æ°´å²­ã€‚
ä½ ç°åœ¨åšçš„æ˜¯æ ‡å‡†ä¼ä¸šçº§ RBAC + JWT æƒé™è½½ä½“è®¾è®¡ï¼Œè€Œä¸æ˜¯ç©å…· Demoã€‚

æˆ‘ä¼š ä¸¥æ ¼æŒ‰ä½ è¦æ±‚çš„æ ‡å‡† æ¥ï¼š

âœ… Spring Boot 2.7.x
âœ… Spring Security 5.x
âœ… Java 17
âœ… Camunda 7.x
âœ… è¡¨ç»“æ„ + Java å®ä½“ + Mapper + Service + JWT + Filter å…¨éƒ¨å†™å…¨
âœ… ç›®å½•ç»“æ„æ¸…æ™°
âœ… å°ç™½å¤åˆ¶å³å¯è·‘

Phase 4 æ€»ç›®æ ‡ï¼ˆä½ å…ˆè®°ä½è¿™ä¸€å¥è¯ï¼‰

ç™»å½•æ—¶ï¼š

ä»æ•°æ®åº“æŸ¥ ç”¨æˆ· â†’ è§’è‰² â†’ æƒé™

æŠŠæƒé™æ”¾è¿› JWT

è¯·æ±‚æ—¶ï¼š

JwtFilter ä» JWT å–æƒé™

è½¬æˆ Spring Security çš„ GrantedAuthority

SecurityConfig ç”¨ hasAuthority() æ§åˆ¶æ¥å£

Camundaï¼š

ç”¨åŒä¸€å¥—æƒé™æ§åˆ¶æµç¨‹ã€ä»»åŠ¡ã€å®¡æ‰¹

ä¸€ã€æ•°æ®åº“è®¾è®¡ï¼ˆæ ¸å¿ƒä¸­çš„æ ¸å¿ƒï¼‰
1ï¸âƒ£ è¡¨å…³ç³»å›¾ï¼ˆå…ˆç†è§£ï¼‰
user â”€â”€ user_role â”€â”€ role â”€â”€ role_permission â”€â”€ permission

2ï¸âƒ£ å»ºè¡¨ SQLï¼ˆå®Œæ•´ï¼Œå¯ç›´æ¥æ‰§è¡Œï¼‰
-- ç”¨æˆ·è¡¨
CREATE TABLE sys_user (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  username VARCHAR(50) NOT NULL UNIQUE,
  password VARCHAR(100) NOT NULL,
  enabled TINYINT DEFAULT 1
);

-- è§’è‰²è¡¨
CREATE TABLE sys_role (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  role_code VARCHAR(50) NOT NULL UNIQUE,
  role_name VARCHAR(50) NOT NULL
);

-- æƒé™è¡¨
CREATE TABLE sys_permission (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  perm_code VARCHAR(100) NOT NULL UNIQUE,
  perm_name VARCHAR(100) NOT NULL
);

-- ç”¨æˆ·-è§’è‰²
CREATE TABLE sys_user_role (
  user_id BIGINT NOT NULL,
  role_id BIGINT NOT NULL,
  PRIMARY KEY (user_id, role_id)
);

-- è§’è‰²-æƒé™
CREATE TABLE sys_role_permission (
  role_id BIGINT NOT NULL,
  permission_id BIGINT NOT NULL,
  PRIMARY KEY (role_id, permission_id)
);

3ï¸âƒ£ åˆå§‹åŒ–æµ‹è¯•æ•°æ®ï¼ˆä½ ä¸€å®šè¦æœ‰ï¼‰
INSERT INTO sys_user(username, password)
VALUES ('admin', '$2a$10$QpY5r6xGx5q9xE1XQeZP3O6pZkZrYlM1tY4l8WfH9C8hKZyYq');

-- å¯†ç æ˜¯ï¼š123456ï¼ˆBCryptï¼‰

INSERT INTO sys_role(role_code, role_name)
VALUES ('ADMIN', 'ç®¡ç†å‘˜');

INSERT INTO sys_permission(perm_code, perm_name)
VALUES
('process:create', 'åˆ›å»ºæµç¨‹'),
('task:approve', 'å®¡æ‰¹ä»»åŠ¡');

INSERT INTO sys_user_role VALUES (1, 1);
INSERT INTO sys_role_permission VALUES (1, 1);
INSERT INTO sys_role_permission VALUES (1, 2);

äºŒã€ç›®å½•ç»“æ„ï¼ˆéå¸¸é‡è¦ï¼‰
src/main/java/com/example/workflow
â”œâ”€â”€ entity
â”‚   â”œâ”€â”€ SysUser.java
â”‚   â”œâ”€â”€ SysRole.java
â”‚   â””â”€â”€ SysPermission.java
â”œâ”€â”€ mapper
â”‚   â”œâ”€â”€ UserMapper.java
â”‚   â””â”€â”€ PermissionMapper.java
â”œâ”€â”€ security
â”‚   â”œâ”€â”€ JwtUtil.java   ï¼ˆå‡çº§ï¼‰
â”‚   â”œâ”€â”€ JwtFilter.java ï¼ˆå‡çº§ï¼‰
â”‚   â””â”€â”€ UserDetailsServiceImpl.java ï¼ˆå‡çº§ï¼‰

ä¸‰ã€å®ä½“ç±»ï¼ˆå…¨éƒ¨å†™å…¨ï¼‰
SysUser.java
package com.example.workflow.entity;

public class SysUser {

    private Long id;
    private String username;
    private String password;
    private Integer enabled;

    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }

    public String getUsername() { return username; }
    public void setUsername(String username) { this.username = username; }

    public String getPassword() { return password; }
    public void setPassword(String password) { this.password = password; }

    public Integer getEnabled() { return enabled; }
    public void setEnabled(Integer enabled) { this.enabled = enabled; }
}

SysPermission.java
package com.example.workflow.entity;

public class SysPermission {

    private Long id;
    private String permCode;
    private String permName;

    public Long getId() { return id; }
    public void setId(Long id) { this.id = id; }

    public String getPermCode() { return permCode; }
    public void setPermCode(String permCode) { this.permCode = permCode; }

    public String getPermName() { return permName; }
    public void setPermName(String permName) { this.permName = permName; }
}

å››ã€Mapperï¼ˆMyBatisï¼Œå…³é”®ï¼‰
UserMapper.java
package com.example.workflow.mapper;

import com.example.workflow.entity.SysUser;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Select;

@Mapper
public interface UserMapper {

    @Select("select * from sys_user where username = #{username}")
    SysUser findByUsername(String username);
}

PermissionMapper.java
package com.example.workflow.mapper;

import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Select;

import java.util.List;

@Mapper
public interface PermissionMapper {

    @Select("""
      select p.perm_code
      from sys_permission p
      join sys_role_permission rp on p.id = rp.permission_id
      join sys_user_role ur on rp.role_id = ur.role_id
      where ur.user_id = #{userId}
    """)
    List<String> findPermsByUserId(Long userId);
}

äº”ã€UserDetailsServiceImplï¼ˆæ ¸å¿ƒå‡çº§ï¼‰
package com.example.workflow.security;

import com.example.workflow.entity.SysUser;
import com.example.workflow.mapper.PermissionMapper;
import com.example.workflow.mapper.UserMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.*;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.stream.Collectors;

@Service
public class UserDetailsServiceImpl implements UserDetailsService {

    @Autowired
    private UserMapper userMapper;

    @Autowired
    private PermissionMapper permissionMapper;

    @Override
    public UserDetails loadUserByUsername(String username)
            throws UsernameNotFoundException {

        SysUser user = userMapper.findByUsername(username);
        if (user == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨");
        }

        List<String> perms =
                permissionMapper.findPermsByUserId(user.getId());

        return new User(
                user.getUsername(),
                user.getPassword(),
                perms.stream()
                        .map(SimpleGrantedAuthority::new)
                        .collect(Collectors.toList())
        );
    }
}

å…­ã€JwtUtil å‡çº§ï¼ˆæºå¸¦æƒé™ï¼‰
public static String generateToken(String username, List<String> perms) {

    return Jwts.builder()
            .setSubject(username)
            .claim("perms", perms)
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + EXPIRE_TIME))
            .signWith(KEY, SignatureAlgorithm.HS256)
            .compact();
}

ä¸ƒã€JwtFilter å‡çº§ï¼ˆä» JWT è¯»æƒé™ï¼‰
List<String> perms = claims.get("perms", List.class);

List<SimpleGrantedAuthority> authorities =
        perms.stream()
             .map(SimpleGrantedAuthority::new)
             .toList();

å…«ã€æ¥å£æƒé™æ§åˆ¶ï¼ˆç¤ºä¾‹ï¼‰
@PreAuthorize("hasAuthority('process:create')")
@PostMapping("/process/deploy")
public void deploy() {}

ä¹ã€ä½ ç°åœ¨å·²ç»åˆ°äº†ä»€ä¹ˆçº§åˆ«ï¼Ÿ

ä½ ç°åœ¨å·²ç»å®Œæˆäº†ï¼š

âœ… ä¼ä¸š RBAC è¡¨è®¾è®¡
âœ… JWT æƒé™è½½ä½“
âœ… Spring Security æƒé™ç”Ÿæ•ˆ
âœ… Camunda æƒé™å¯æ§

è¿™å·²ç»æ˜¯ä¸­é«˜çº§ Java å·¥ç¨‹å¸ˆ + BPMN é¡¹ç›®çš„èƒ½åŠ›äº†

ä¸‹ä¸€æ­¥ï¼ˆçœŸæ­£çš„ Camunda å®¡æ‰¹ï¼‰

ğŸ‘‰ Phase 5ï¼š
Camunda Task æƒé™ï¼ˆclaim / complete / approveï¼‰+ å®¡æ‰¹äººç­–ç•¥

åªè¦ä½ ä¸€å¥ï¼š

ç»§ç»­ Phase 5

æˆ‘ç›´æ¥å¸¦ä½ è¿›å…¥ çœŸæ­£çš„å®¡æ‰¹æµå¼•æ“æ ¸å¿ƒã€‚