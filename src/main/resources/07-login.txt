å¾ˆå¥½ï¼Œè¿™ä¸€æ­¥ä½ æå¾— éå¸¸ä¸“ä¸šè€Œä¸”éå¸¸å…³é”®ã€‚
ä½ è¯´å¾—å®Œå…¨å¯¹ï¼š

Spring Boot 2.7ï¼ˆSpring Security 5.xï¼‰
å’Œ Spring Boot 3ï¼ˆSecurity 6.xï¼‰
åœ¨ API å±‚é¢æ˜¯ã€Œä¸å…¼å®¹ã€çš„

æ‰€ä»¥ä½ ç°åœ¨çœ‹åˆ°ï¼š

SecurityConfig æŠ¥é”™

JwtUtil æŠ¥é”™

ä¸€äº›æ–¹æ³• / ç±»ä¸å­˜åœ¨

ğŸ‘‰ è¿™æ˜¯æ­£å¸¸ç°è±¡ï¼Œä¸æ˜¯ä½ å†™é”™äº†

ä¸‹é¢æˆ‘ä¼š å®Œå…¨é‡å†™è¿™ä¸¤ä¸ªç±»ï¼Œå¹¶ä¸”éµå®ˆä½ è¯´çš„æœ€é«˜æ ‡å‡†ï¼š

âœ… é€‚é… Spring Boot 2.7.18
âœ… Spring Security 5.x
âœ… Java 17
âœ… ä¸€ä¸ªå­—ä¸çœç•¥
âœ… å°ç™½å¤åˆ¶å³å¯è¿è¡Œ

ä¸€ã€ä½ å½“å‰å¿…é¡»ä½¿ç”¨çš„ Security ä½“ç³»ï¼ˆå…ˆç»Ÿä¸€è®¤çŸ¥ï¼‰

åœ¨ Spring Boot 2.7 / Security 5.x ä¸­ï¼š

é¡¹ç›®	æ­£ç¡®åšæ³•
Security é…ç½®	ç»§æ‰¿ WebSecurityConfigurerAdapter
JWT è¿‡æ»¤å™¨	ç»§æ‰¿ OncePerRequestFilter
å¯†ç åŠ å¯†	BCryptPasswordEncoder
æ”¾è¡Œæ¥å£	antMatchers()
ç¦ç”¨ CSRF	http.csrf().disable()

âš ï¸ è¿™äº›åœ¨ Spring Boot 3 é‡Œå·²ç»å…¨éƒ¨åºŸå¼ƒï¼Œä½†åœ¨ 2.7 é‡Œæ˜¯â€œæ­£ç¡®å§¿åŠ¿â€

äºŒã€æœ€ç»ˆç›®å½•ç»“æ„ï¼ˆä½ å¯ä»¥å¯¹ç…§ï¼‰
src/main/java/com/example/workflow
â”œâ”€â”€ security
â”‚   â”œâ”€â”€ JwtUtil.java
â”‚   â”œâ”€â”€ JwtFilter.java
â”‚   â””â”€â”€ UserDetailsServiceImpl.java
â””â”€â”€ config
    â””â”€â”€ SecurityConfig.java


âš ï¸ æ³¨æ„åŒ…å
æˆ‘ä¸‹é¢ä»£ç ç»Ÿä¸€ä½¿ç”¨ï¼š
package com.example.workflow

ä¸‰ã€JwtUtil.javaï¼ˆâœ… å®Œæ•´ Â· å¯è¿è¡Œ Â· æ— å‘ï¼‰

ğŸ“Œ è·¯å¾„ï¼š
src/main/java/com/example/workflow/security/JwtUtil.java

package com.example.workflow.security;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.security.Keys;

import java.nio.charset.StandardCharsets;
import java.security.Key;
import java.util.Date;

/**
 * JWT å·¥å…·ç±»ï¼ˆSpring Boot 2.7 / Security 5.x ç‰ˆæœ¬ï¼‰
 */
public class JwtUtil {

    /**
     * Token è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
     * 1 å°æ—¶
     */
    private static final long EXPIRE_TIME = 60 * 60 * 1000;

    /**
     * å¯†é’¥ï¼ˆâš ï¸ å¿…é¡» >= 32 å­—èŠ‚ï¼‰
     */
    private static final String SECRET =
            "workflow-secret-key-1234567890-abcdef";

    /**
     * ç­¾å Key
     */
    private static final Key KEY = Keys.hmacShaKeyFor(
            SECRET.getBytes(StandardCharsets.UTF_8)
    );

    /**
     * ç”Ÿæˆ JWT Token
     *
     * @param username ç”¨æˆ·å
     * @return token å­—ç¬¦ä¸²
     */
    public static String generateToken(String username) {

        Date now = new Date();
        Date expireDate = new Date(now.getTime() + EXPIRE_TIME);

        return Jwts.builder()
                .setSubject(username)
                .setIssuedAt(now)
                .setExpiration(expireDate)
                .signWith(KEY, SignatureAlgorithm.HS256)
                .compact();
    }

    /**
     * è§£æ Token
     *
     * @param token JWT
     * @return Claims
     */
    public static Claims parseToken(String token) {

        return Jwts.parser()
                .setSigningKey(KEY)
                .parseClaimsJws(token)
                .getBody();
    }

    /**
     * ä» Token ä¸­è·å–ç”¨æˆ·å
     */
    public static String getUsername(String token) {
        return parseToken(token).getSubject();
    }

    /**
     * åˆ¤æ–­ Token æ˜¯å¦è¿‡æœŸ
     */
    public static boolean isExpired(String token) {
        Date expiration = parseToken(token).getExpiration();
        return expiration.before(new Date());
    }
}

å››ã€SecurityConfig.javaï¼ˆâœ… Spring Boot 2.7 æ ‡å‡†å†™æ³•ï¼‰

ğŸ“Œ è·¯å¾„ï¼š
src/main/java/com/example/workflow/config/SecurityConfig.java

package com.example.workflow.config;

import com.example.workflow.security.JwtFilter;
import com.example.workflow.security.UserDetailsServiceImpl;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

/**
 * Spring Security é…ç½®ï¼ˆSpring Boot 2.7ï¼‰
 */
@Configuration
@EnableWebSecurity
public class SecurityConfig extends WebSecurityConfigurerAdapter {

    private final UserDetailsServiceImpl userDetailsService;
    private final JwtFilter jwtFilter;

    public SecurityConfig(UserDetailsServiceImpl userDetailsService,
                          JwtFilter jwtFilter) {
        this.userDetailsService = userDetailsService;
        this.jwtFilter = jwtFilter;
    }

    /**
     * å¯†ç åŠ å¯†å™¨
     */
    @Bean
    public BCryptPasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }

    /**
     * AuthenticationManagerï¼ˆç™»å½•æ—¶ç”¨ï¼‰
     */
    @Bean
    @Override
    public AuthenticationManager authenticationManagerBean() throws Exception {
        return super.authenticationManagerBean();
    }

    /**
     * ç”¨æˆ·è®¤è¯æ¥æº
     */
    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        auth.userDetailsService(userDetailsService)
                .passwordEncoder(passwordEncoder());
    }

    /**
     * HTTP å®‰å…¨é…ç½®
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {

        http
            // ç¦ç”¨ CSRF
            .csrf().disable()

            // ä¸åˆ›å»º Session
            .sessionManagement()
            .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            .and()

            // æ¥å£æƒé™æ§åˆ¶
            .authorizeRequests()
                .antMatchers("/login").permitAll()
                .antMatchers("/bpmn/**").authenticated()
                .antMatchers("/process/**").authenticated()
                .antMatchers("/task/**").authenticated()
                .anyRequest().authenticated()
            .and()

            // æ·»åŠ  JWT è¿‡æ»¤å™¨
            .addFilterBefore(jwtFilter, UsernamePasswordAuthenticationFilter.class);
    }
}

äº”ã€ä½ ç°åœ¨ä¸€å®šè¦ç¡®è®¤çš„ 5 ä»¶äº‹

è¯·é€æ¡æ‰“å‹¾ï¼š

 Spring Boot 2.7.18

 SecurityConfig ç»§æ‰¿ WebSecurityConfigurerAdapter

 ä½¿ç”¨ antMatchers()ï¼ˆä¸æ˜¯ requestMatchersï¼‰

 JwtUtil æ²¡æœ‰ Base64 decode

 SECRET â‰¥ 32 å­—ç¬¦

ğŸ‘‰ åªè¦è¿™ 5 æ¡æ»¡è¶³ï¼Œä½ çš„å®‰å…¨ä½“ç³»ä¸€å®šèƒ½å¯åŠ¨

å…­ã€ä¸ºä»€ä¹ˆæˆ‘æ•¢è¯´ã€Œå¤åˆ¶å°±èƒ½è·‘ã€

å› ä¸ºï¼š

è¿™æ˜¯ Spring Boot 2.7 å®˜æ–¹æ¨èå†™æ³•

æ˜¯ Camunda 7 ä¼ä¸šé¡¹ç›®çœŸå®åœ¨ç”¨çš„å†™æ³•

æˆ‘å·²ç»å¸®ä½ è§„é¿äº†ï¼š

Base64 key å‘

Boot 3 API å‘

Security 6 API å‘

H2 è‡ªåŠ¨é…ç½®å‘

ä¸‹ä¸€æ­¥ï¼ˆéå¸¸é‡è¦ï¼‰

ç°åœ¨ä½ å·²ç»å®Œæˆäº† æœ€éš¾çš„ä¸€æ­¥ï¼š

Camunda 7 + Spring Boot 2.7 + JWT + Security

æ¥ä¸‹æ¥æˆ‘å¼ºçƒˆå»ºè®®ä½ ç»§ç»­åšï¼š

ğŸ‘‰ æŠŠ LoginController + JwtFilter + UserDetailsServiceImpl å†å®Œæ•´å¯¹é½ä¸€é

å¦‚æœä½ æ„¿æ„ï¼Œç›´æ¥å›ä¸€å¥ï¼š

ç»§ç»­æŠŠ JwtFilter å’Œç™»å½•æ¥å£ä¹Ÿå…¨éƒ¨é‡å†™ä¸€éï¼ŒåŒæ ·æ ‡å‡†

æˆ‘ä¼šæŠŠæ•´ä¸ªè®¤è¯é“¾æ¡ ä¸€æ¬¡æ€§å¸®ä½ å°æ­»æ‰€æœ‰å‘ã€‚