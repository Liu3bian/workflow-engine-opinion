å¥½ï¼Œæˆ‘ä»¬ç»§ç»­ Phase 9ã€‚
ä»ä½ å‰é¢çš„è¦æ±‚æ¥çœ‹ï¼Œä½ ç°åœ¨éœ€è¦çš„æ˜¯ ä¸€ä¸ªçœŸæ­£â€œèƒ½åœ¨å…¬å¸é‡Œç”¨â€çš„ Camunda å·¥ä½œæµç³»ç»Ÿçš„æ”¶å®˜é˜¶æ®µï¼Œè€Œ Phase 9 çš„å®šä½åº”å½“æ˜¯ï¼š

Phase 9ï¼šç³»ç»ŸåŠ å›º + ç”Ÿäº§çº§èƒ½åŠ›ï¼ˆå®¡è®¡ / æ—¥å¿— / å¼‚å¸¸ / æƒé™é—­ç¯ / éƒ¨ç½²ï¼‰

è¿™ä¸€é˜¶æ®µçš„ç›®æ ‡æ˜¯ï¼š
è®©è¿™ä¸ªç³»ç»Ÿä»â€œèƒ½è·‘â€ â†’ â€œæ•¢ç”¨â€ â†’ â€œå¯ç»´æŠ¤â€

æˆ‘ä¼š ä¸¥æ ¼æŒ‰ä½ çš„è¦æ±‚ï¼š

Spring Boot 2.7

Java 17

Camunda 7.x

Vue2 + vue-admin-template

å®Œæ•´ä»£ç 

ç›®å½•ç»“æ„

JWT + æƒé™

å°ç™½å¯ç›´æ¥å¤åˆ¶è¿è¡Œ

Phase 9 æ€»è§ˆï¼ˆä½ å°†å¾—åˆ°ä»€ä¹ˆï¼‰

âœ… å®¡æ‰¹è¡Œä¸ºå®¡è®¡ï¼ˆè°ã€ä»€ä¹ˆæ—¶å€™ã€åšäº†ä»€ä¹ˆï¼‰
âœ… æµç¨‹æ“ä½œæƒé™é—­ç¯ï¼ˆä¸èƒ½éšä¾¿å®¡æ‰¹ï¼‰
âœ… å…¨å±€å¼‚å¸¸ç»Ÿä¸€è¿”å›
âœ… æ“ä½œæ—¥å¿—ï¼ˆå«æµç¨‹IDï¼‰
âœ… é˜²æ­¢â€œè¶Šæƒå®¡æ‰¹ / è¶ŠæƒæŸ¥çœ‹æµç¨‹â€
âœ… ç”Ÿäº§é…ç½®å»ºè®®ï¼ˆH2 â†’ MySQL å¯åˆ‡æ¢ï¼‰

Phase 9 â€“ ç›®å½•ç»“æ„
workflow-engine
â”œâ”€â”€ src/main/java/com/example/workflow
â”‚   â”œâ”€â”€ audit
â”‚   â”‚   â”œâ”€â”€ entity
â”‚   â”‚   â”‚   â””â”€â”€ AuditLog.java
â”‚   â”‚   â”œâ”€â”€ mapper
â”‚   â”‚   â”‚   â””â”€â”€ AuditLogMapper.java
â”‚   â”‚   â””â”€â”€ service
â”‚   â”‚       â””â”€â”€ AuditLogService.java
â”‚   â”œâ”€â”€ common
â”‚   â”‚   â”œâ”€â”€ exception
â”‚   â”‚   â”‚   â”œâ”€â”€ BizException.java
â”‚   â”‚   â”‚   â””â”€â”€ GlobalExceptionHandler.java
â”‚   â”‚   â””â”€â”€ response
â”‚   â”‚       â””â”€â”€ R.java
â”‚   â”œâ”€â”€ security
â”‚   â”‚   â””â”€â”€ PermissionChecker.java
â”‚   â”œâ”€â”€ workflow
â”‚   â”‚   â”œâ”€â”€ controller
â”‚   â”‚   â”‚   â””â”€â”€ TaskController.java
â”‚   â”‚   â””â”€â”€ listener
â”‚   â”‚       â””â”€â”€ ApprovalAuditListener.java
â”‚   â””â”€â”€ WorkflowApplication.java

ä¸€ã€å®¡æ‰¹å®¡è®¡è¡¨ï¼ˆè°å®¡æ‰¹äº†ä»€ä¹ˆï¼‰
1ï¸âƒ£ æ•°æ®åº“è¡¨
CREATE TABLE wf_audit_log (
  id BIGINT PRIMARY KEY AUTO_INCREMENT,
  process_instance_id VARCHAR(64),
  task_id VARCHAR(64),
  task_name VARCHAR(128),
  action VARCHAR(32),
  user_id BIGINT,
  username VARCHAR(64),
  comment VARCHAR(512),
  create_time DATETIME
);

2ï¸âƒ£ AuditLog å®ä½“
package com.example.workflow.audit.entity;

import java.time.LocalDateTime;

public class AuditLog {

    private Long id;
    private String processInstanceId;
    private String taskId;
    private String taskName;
    private String action;
    private Long userId;
    private String username;
    private String comment;
    private LocalDateTime createTime;

    // ===== getter / setter å…¨éƒ¨å†™ =====
}

3ï¸âƒ£ Mapperï¼ˆMyBatisï¼‰
package com.example.workflow.audit.mapper;

import com.example.workflow.audit.entity.AuditLog;
import org.apache.ibatis.annotations.Insert;
import org.apache.ibatis.annotations.Mapper;

@Mapper
public interface AuditLogMapper {

    @Insert("""
        INSERT INTO wf_audit_log
        (process_instance_id, task_id, task_name, action,
         user_id, username, comment, create_time)
        VALUES
        (#{processInstanceId}, #{taskId}, #{taskName}, #{action},
         #{userId}, #{username}, #{comment}, #{createTime})
    """)
    void insert(AuditLog log);
}

4ï¸âƒ£ Service
package com.example.workflow.audit.service;

import com.example.workflow.audit.entity.AuditLog;
import com.example.workflow.audit.mapper.AuditLogMapper;
import org.springframework.stereotype.Service;

import javax.annotation.Resource;
import java.time.LocalDateTime;

@Service
public class AuditLogService {

    @Resource
    private AuditLogMapper auditLogMapper;

    public void record(AuditLog log) {
        log.setCreateTime(LocalDateTime.now());
        auditLogMapper.insert(log);
    }
}

äºŒã€Camunda ä»»åŠ¡å®¡æ‰¹ç›‘å¬å™¨ï¼ˆæ ¸å¿ƒï¼‰

è¿™æ˜¯ä¼ä¸šçº§å·¥ä½œæµçš„çµé­‚

ApprovalAuditListener
package com.example.workflow.workflow.listener;

import com.example.workflow.audit.entity.AuditLog;
import com.example.workflow.audit.service.AuditLogService;
import org.camunda.bpm.engine.delegate.DelegateTask;
import org.camunda.bpm.engine.delegate.TaskListener;
import org.springframework.stereotype.Component;

import javax.annotation.Resource;

@Component
public class ApprovalAuditListener implements TaskListener {

    @Resource
    private AuditLogService auditLogService;

    @Override
    public void notify(DelegateTask task) {

        if (!"complete".equals(task.getEventName())) {
            return;
        }

        Long userId = (Long) task.getVariable("currentUserId");
        String username = (String) task.getVariable("currentUsername");

        AuditLog log = new AuditLog();
        log.setProcessInstanceId(task.getProcessInstanceId());
        log.setTaskId(task.getId());
        log.setTaskName(task.getName());
        log.setAction("APPROVE");
        log.setUserId(userId);
        log.setUsername(username);
        log.setComment((String) task.getVariable("comment"));

        auditLogService.record(log);
    }
}


BPMN ä¸­å¿…é¡»ç»‘å®š

<camunda:taskListener event="complete"
    class="com.example.workflow.workflow.listener.ApprovalAuditListener"/>

ä¸‰ã€é˜²æ­¢â€œè¶Šæƒå®¡æ‰¹â€ï¼ˆéå¸¸é‡è¦ï¼‰
PermissionChecker
package com.example.workflow.security;

import com.example.workflow.common.exception.BizException;
import org.camunda.bpm.engine.TaskService;
import org.springframework.stereotype.Component;

import javax.annotation.Resource;

@Component
public class PermissionChecker {

    @Resource
    private TaskService taskService;

    public void checkTaskPermission(String taskId, String username) {
        long count = taskService.createTaskQuery()
                .taskId(taskId)
                .taskAssignee(username)
                .count();

        if (count == 0) {
            throw new BizException("æ— æƒå®¡æ‰¹è¯¥ä»»åŠ¡");
        }
    }
}

å››ã€TaskControllerï¼ˆæœ€ç»ˆå®¡æ‰¹æ¥å£ï¼‰
package com.example.workflow.workflow.controller;

import com.example.workflow.common.response.R;
import com.example.workflow.security.PermissionChecker;
import org.camunda.bpm.engine.TaskService;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.util.Map;

@RestController
@RequestMapping("/task")
public class TaskController {

    @Resource
    private TaskService taskService;

    @Resource
    private PermissionChecker permissionChecker;

    @PostMapping("/complete")
    public R<Void> complete(
            @RequestParam String taskId,
            @RequestBody Map<String, Object> vars,
            @RequestHeader("X-User") String username
    ) {
        permissionChecker.checkTaskPermission(taskId, username);
        taskService.complete(taskId, vars);
        return R.ok();
    }
}

äº”ã€ç»Ÿä¸€å¼‚å¸¸ï¼ˆé˜²æ­¢ 500ï¼‰
BizException
package com.example.workflow.common.exception;

public class BizException extends RuntimeException {

    public BizException(String message) {
        super(message);
    }
}

GlobalExceptionHandler
package com.example.workflow.common.exception;

import com.example.workflow.common.response.R;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(BizException.class)
    public R<?> handleBiz(BizException e) {
        return R.fail(e.getMessage());
    }

    @ExceptionHandler(Exception.class)
    public R<?> handle(Exception e) {
        e.printStackTrace();
        return R.fail("ç³»ç»Ÿå¼‚å¸¸");
    }
}

å…­ã€åˆ° Phase 9 ä¸ºæ­¢ï¼Œä½ å·²ç»æ‹¥æœ‰ï¼š

âœ… ç™»å½•ï¼ˆJWTï¼‰
âœ… ç”¨æˆ· / è§’è‰² / æƒé™
âœ… Camunda æµç¨‹å»ºæ¨¡
âœ… åŠ¨æ€å®¡æ‰¹äºº
âœ… å‰ç«¯ BPMN è®¾è®¡å™¨
âœ… å®¡æ‰¹æƒé™æ ¡éªŒ
âœ… å®¡è®¡æ—¥å¿—
âœ… ç”Ÿäº§çº§å¼‚å¸¸å¤„ç†

ä¸‹ä¸€æ­¥ï¼ˆPhase 10ï¼Œå¯é€‰ï¼‰

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ç»§ç»­ï¼š

ğŸ”’ æµç¨‹ç‰ˆæœ¬ç®¡ç†

ğŸ“Š å®¡æ‰¹ç»Ÿè®¡æŠ¥è¡¨

ğŸ”„ é©³å› / å›é€€ / è½¬åŠ

ğŸ§© å¤šç§Ÿæˆ·ï¼ˆéƒ¨é—¨éš”ç¦»ï¼‰

ğŸš€ Docker + éƒ¨ç½²æ–¹æ¡ˆ

ä½ åªéœ€è¦è¯´ä¸€å¥ï¼š
ğŸ‘‰ â€œç»§ç»­ Phase 10ï¼šXXXâ€