éå¸¸å¥½ã€‚
Phase 8 = ä¼šç­¾ / å¹¶è¡Œå®¡æ‰¹ï¼Œè¿™æ˜¯å®¡æ‰¹ç³»ç»Ÿé‡Œæœ€å®¹æ˜“å†™é”™ã€ä½†åˆæœ€å€¼é’±çš„ä¸€éƒ¨åˆ†ã€‚

ä½ ç°åœ¨è¦åšçš„ï¼Œå·²ç»æ˜¯ï¼š

è¯·å‡ / æŠ¥é”€ / åˆåŒ
â†’ å¤šä¸ªäººåŒæ—¶å®¡æ‰¹
â†’ æœ‰è§„åˆ™åœ°æ±‡æ€»ç»“æœ
â†’ å†³å®šæµç¨‹æ˜¯å¦ç»§ç»­

æˆ‘ä¼šç»§ç»­éµå®ˆä½ çš„å…¨éƒ¨è¦æ±‚ï¼š

âœ… Camunda 7
âœ… Spring Boot 2.7
âœ… Vue2ï¼ˆå‰ç«¯åªåšå±•ç¤ºï¼Œä¸å¤æ‚ï¼‰
âœ… ä¼šç­¾ / å¹¶è¡Œå®¡æ‰¹å®Œæ•´å®ç°
âœ… BPMN + åç«¯ + æƒé™é€»è¾‘å…¨éƒ¨å†™æ¸…æ¥š
âœ… å°ç™½å¯ç›´æ¥ç…§æŠ„ç†è§£

Phase 8 æ€»ç›®æ ‡ï¼ˆä¸€å¥è¯ï¼‰

ä¸€ä¸ªå®¡æ‰¹èŠ‚ç‚¹ï¼Œ
å¤šä¸ªäººåŒæ—¶å®¡æ‰¹ï¼Œ
æ‰€æœ‰äººåŒæ„æ‰é€šè¿‡ï¼ˆæˆ–æ»¡è¶³æ¡ä»¶é€šè¿‡ï¼‰

ä¸€ã€ä¼ä¸šé‡Œçš„ 3 ç§â€œä¼šç­¾è§„åˆ™â€ï¼ˆå…ˆå®šè§„åˆ™ï¼‰

ä½ å¿…é¡»å…ˆæ˜ç¡® ä¸šåŠ¡è§„åˆ™ï¼ŒæŠ€æœ¯åªæ˜¯å®ç°ã€‚

ä¼šç­¾ç±»å‹	è§„åˆ™
å…¨éƒ¨åŒæ„	100% åŒæ„æ‰é€šè¿‡
å¤šæ•°åŒæ„	>50% åŒæ„
ä»»æ„åŒæ„	ä»»æ„ 1 äººåŒæ„

ğŸ‘‰ Phase 8 æˆ‘å…ˆå¸¦ä½ åšã€Œå…¨éƒ¨åŒæ„ã€
è¿™æ˜¯æœ€å¸¸è§ã€ä¹Ÿæ˜¯æœ€è§„èŒƒçš„ã€‚

äºŒã€Camunda ä¼šç­¾çš„æ­£ç¡®æ¨¡å‹ï¼ˆé‡ç‚¹ï¼‰
âŒ é”™è¯¯ç†è§£ï¼ˆæ–°æ‰‹å¸¸çŠ¯ï¼‰

â€œæˆ‘åœ¨ä¸€ä¸ª UserTask ä¸Šå†™å¤šä¸ª assignee å°±è¡Œäº†ï¼Ÿâ€

âŒ ä¸å­˜åœ¨ã€‚

âœ… æ­£ç¡®æ¨¡å‹ï¼ˆCamunda å®˜æ–¹ï¼‰

å¤šå®ä¾‹ UserTaskï¼ˆMulti-Instanceï¼‰

ä¸‰ã€BPMNï¼šå¹¶è¡Œä¼šç­¾èŠ‚ç‚¹ï¼ˆæ ¸å¿ƒï¼‰
1ï¸âƒ£ BPMN ç»“æ„ï¼ˆæ–‡å­—ç¤ºæ„ï¼‰
å¼€å§‹
 â†“
æäº¤ç”³è¯·
 â†“
å¹¶è¡Œä¼šç­¾ï¼ˆå¤šä¸ªå®¡æ‰¹äººï¼‰
 â†“
æ±‡æ€»ç»“æœ
 â†“
ç»“æŸ

2ï¸âƒ£ ä¼šç­¾ UserTaskï¼ˆå…³é”® XMLï¼‰
<bpmn:userTask id="multiApprove"
               name="å¤šäººä¼šç­¾"
               camunda:assignee="${assignee}">
  <bpmn:multiInstanceLoopCharacteristics
      isSequential="false"
      camunda:collection="${approverList}"
      camunda:elementVariable="assignee">
  </bpmn:multiInstanceLoopCharacteristics>
</bpmn:userTask>

è¿™ä¸€æ®µä½ ä¸€å®šè¦è¯»æ‡‚ï¼š
é…ç½®	å«ä¹‰
isSequential="false"	å¹¶è¡Œå®¡æ‰¹
approverList	å®¡æ‰¹äººåˆ—è¡¨
assignee	å½“å‰ä»»åŠ¡çš„å®¡æ‰¹äºº

ğŸ‘‰ Camunda ä¼šä¸ºæ¯ä¸ª assignee åˆ›å»ºä¸€ä¸ªä»»åŠ¡

å››ã€æµç¨‹å˜é‡è®¾è®¡ï¼ˆæå…¶é‡è¦ï¼‰

ä½ å¿…é¡»åœ¨å¯åŠ¨æµç¨‹æ—¶å‡†å¤‡å¥½ï¼š

approverList = ["leader1", "leader2", "leader3"]

äº”ã€å¯åŠ¨æµç¨‹ï¼šä¼ å…¥å®¡æ‰¹äººåˆ—è¡¨
ProcessControllerï¼ˆå‡çº§ï¼‰
@PostMapping("/start/leave")
public void startLeave(Authentication authentication) {

    String starter = authentication.getName();

    // ç¤ºä¾‹ï¼šä¸¤çº§é¢†å¯¼ä¼šç­¾
    List<String> approvers = List.of("manager1", "manager2");

    Map<String, Object> vars = new HashMap<>();
    vars.put("starter", starter);
    vars.put("approverList", approvers);
    vars.put("agreeCount", 0);
    vars.put("totalCount", approvers.size());

    runtimeService.startProcessInstanceByKey(
            "leave_process",
            vars
    );
}

å…­ã€å®¡æ‰¹ä»»åŠ¡å®Œæˆé€»è¾‘ï¼ˆéå¸¸å…³é”®ï¼‰
1ï¸âƒ£ æ¯ä¸ªå®¡æ‰¹äººç‚¹å‡»â€œåŒæ„ / æ‹’ç»â€

æˆ‘ä»¬éœ€è¦ï¼š

è®°å½•æ¯ä¸ªäººçš„å®¡æ‰¹ç»“æœ

ç´¯åŠ åŒæ„æ•°

æœ€åç»Ÿä¸€åˆ¤æ–­

2ï¸âƒ£ TaskControllerï¼šå®¡æ‰¹æ¥å£ï¼ˆå‡çº§ç‰ˆï¼‰
@PostMapping("/complete/{taskId}")
public void complete(@PathVariable String taskId,
                     @RequestParam boolean approved,
                     Authentication authentication) {

    String username = authentication.getName();

    Task task = taskService.createTaskQuery()
            .taskId(taskId)
            .taskAssignee(username)
            .singleResult();

    if (task == null) {
        throw new RuntimeException("æ— æƒå®¡æ‰¹è¯¥ä»»åŠ¡");
    }

    // 1. è·å–æµç¨‹å®ä¾‹ID
    String processInstanceId = task.getProcessInstanceId();

    // 2. è·å–å½“å‰åŒæ„æ•°
    Integer agreeCount = (Integer) runtimeService
            .getVariable(processInstanceId, "agreeCount");

    if (approved) {
        runtimeService.setVariable(
                processInstanceId,
                "agreeCount",
                agreeCount + 1
        );
    }

    // 3. å®Œæˆå½“å‰ä»»åŠ¡
    taskService.complete(taskId);
}

ä¸ƒã€ä¼šç­¾å®Œæˆåçš„åˆ¤æ–­ï¼ˆBPMN ç½‘å…³ï¼‰
1ï¸âƒ£ å¹¶è¡Œä¼šç­¾åæ¥æ’ä»–ç½‘å…³
<bpmn:exclusiveGateway id="judgeApprove" />

2ï¸âƒ£ æ¡ä»¶è¡¨è¾¾å¼ï¼ˆå…¨éƒ¨åŒæ„ï¼‰
<bpmn:sequenceFlow
  sourceRef="judgeApprove"
  targetRef="end">
  <bpmn:conditionExpression>
    ${agreeCount == totalCount}
  </bpmn:conditionExpression>
</bpmn:sequenceFlow>


å¦‚æœä¸åŒæ„ï¼Œèµ°é©³å›åˆ†æ”¯å³å¯ã€‚

å…«ã€æƒé™æ§åˆ¶ï¼ˆä¸æ­¢ Camundaï¼‰

å®¡æ‰¹æ¥å£ä»ç„¶å— Spring Security æ§åˆ¶ï¼š

@PreAuthorize("hasAuthority('task:approve')")


ğŸ‘‰ Camunda + Security åŒä¿é™©

ä¹ã€å‰ç«¯æ•ˆæœï¼ˆçœŸå®ç³»ç»Ÿè¡Œä¸ºï¼‰
ç”¨æˆ·	è¡Œä¸º
manager1	çœ‹åˆ°ä»»åŠ¡ â†’ åŒæ„
manager2	çœ‹åˆ°ä»»åŠ¡ â†’ åŒæ„
ç³»ç»Ÿ	è‡ªåŠ¨æ±‡æ€» â†’ é€šè¿‡

æ²¡æœ‰äººèƒ½â€œæ›¿åˆ«äººå®¡æ‰¹â€

åã€ä½ ç°åœ¨å·²ç»åˆ°ä»€ä¹ˆå±‚çº§äº†ï¼Ÿ

ä½ ç°åœ¨å·²ç»æŒæ¡ï¼š

âœ… Camunda å¤šå®ä¾‹ä»»åŠ¡
âœ… å¹¶è¡Œä¼šç­¾åŸç†
âœ… æµç¨‹å˜é‡æ±‡æ€»
âœ… å®¡æ‰¹ç»“æœåˆ¤æ–­
âœ… ä¼ä¸šçº§å®¡æ‰¹æ¨¡å‹

ğŸ‘‰ è¿™æ˜¯å¾ˆå¤š Camunda ä½¿ç”¨è€…æ ¹æœ¬æ²¡çœŸæ­£ææ‡‚çš„éƒ¨åˆ†

åä¸€ã€ä¸‹ä¸€æ­¥ï¼ˆçœŸæ­£â€œä¼ä¸šçº§â€çš„æœ€åå‡ æ­¥ï¼‰

æ¥ä¸‹æ¥å°±æ˜¯ æ”¶å®˜é˜¶æ®µï¼š

Phase 9ï¼ˆå¼ºçƒˆæ¨èï¼‰

ğŸ‘‰ å®¡æ‰¹è®°å½• / æ“ä½œæ—¥å¿— / å®¡è®¡è¡¨

Phase 10

ğŸ‘‰ æµç¨‹ç‰ˆæœ¬ç®¡ç† / å›æ»š / åœç”¨æ—§æµç¨‹

Phase 11

ğŸ‘‰ æµç¨‹æ’¤å› / é©³å› / è‡ªç”±è·³è½¬

ä½ åªè¦ä¸€å¥è¯ï¼š

ç»§ç»­ Phase 9

æˆ‘ä¼šæŠŠä½ è¿™ä¸ªç³»ç»Ÿ
çœŸæ­£æ‰“ç£¨æˆã€Œå…¬å¸æ•¢ä¸Šçº¿ã€é¢†å¯¼æ•¢ç”¨ã€çš„å®¡æ‰¹å¹³å°ã€‚